<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Reader</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

body {
  background: #f7f8fa;
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
}

.title {
  text-align: center;
  font-size: 32px;
  font-weight: bold;
  color: #2c3e50;
  margin: 30px 0 20px;
}

#voiceSelect {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 1px solid #ddd;
  border-radius: 12px;
  margin-bottom: 10px;
  background: #fff;
  outline: none;
}

#inputArea {
  width: 100%;
  height: 180px;
  padding: 15px;
  font-size: 16px;
  border: 1px solid #ddd;
  border-radius: 12px;
  resize: vertical;
  outline: none;
  background: white;
}

#goBtn {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  font-weight: 600;
  background: #007aff;
  color: white;
  border: none;
  border-radius: 12px;
  margin: 12px 0 25px;
  cursor: pointer;
}

#result {
  line-height: 1.8;
  font-size: 18px;
}

.sentence {
  display: flex;
  align-items: center;
  padding: 14px 12px;
  border-radius: 10px;
  margin-bottom: 10px;
  background: #fff;
  border: 1px solid #eee;
  transition: background 0.2s;
  cursor: pointer;
}

.sentence.active {
  background: #e1f5fe;
  border-color: #007aff;
}

.speaker {
  margin-right: 12px;
  font-size: 24px;
  user-select: none;
  flex-shrink: 0;
}

.word {
  display: inline-block;
  padding: 2px 4px;
  border-radius: 4px;
  cursor: pointer;
}

.word.active {
  background: #ffeb3b;
  font-weight: 500;
}
</style>
</head>

<body>
  <div class="title">English Reader</div>

  <select id="voiceSelect"></select>

  <textarea id="inputArea" placeholder="Paste your English text here..."></textarea>
  <button id="goBtn">Go</button>
  <div id="result"></div>

<script>
const inputArea = document.getElementById('inputArea');
const goBtn = document.getElementById('goBtn');
const result = document.getElementById('result');
const voiceSelect = document.getElementById('voiceSelect');

let allVoices = [];
let currentUtterance = null;

// åŠ è½½æ‰€æœ‰å£°éŸ³ï¼Œå¹¶é»˜è®¤é€‰ä¸­ Samantha
function loadVoices() {
  allVoices = window.speechSynthesis.getVoices();
  voiceSelect.innerHTML = '';

  allVoices.forEach((voice, i) => {
    if (voice.lang.includes('en')) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    }
  });

  // è‡ªåŠ¨é€‰ä¸­ Samantha
  const samanthaIndex = allVoices.findIndex(v => 
    v.name.includes('Samantha') && v.lang.includes('en-US')
  );
  if (samanthaIndex !== -1) {
    voiceSelect.value = samanthaIndex;
  }
}

// è·å–å½“å‰é€‰ä¸­çš„å£°éŸ³
function getSelectedVoice() {
  return allVoices[voiceSelect.value] || allVoices.find(v => v.lang.includes('en-US'));
}

window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

// ========== ã€æ ¸å¿ƒä¿®æ”¹1ï¼šå…¨é‡è‹±æ–‡ç¼©å†™åº“ï¼Œè¦†ç›–æ‰€æœ‰å¸¸ç”¨å¸¦ç‚¹ç¼©å†™ï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‘==========
// æŒ‰é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œé¿å…çŸ­ç¼©å†™æå‰æˆªæ–­é•¿ç¼©å†™
const englishAbbrs = [
  // å¤šæ®µé•¿ç¼©å†™ï¼ˆä¼˜å…ˆåŒ¹é…ï¼‰
  'U\\.S\\.A\\.', 'P\\.R\\.C\\.', 'R\\.O\\.C\\.', 'U\\.K\\.', 'E\\.U\\.', 'U\\.N\\.',
  'et al\\.', 'op\\. cit\\.', 'loc\\. cit\\.', 'viz\\.', 'cf\\.', 'ibid\\.', 'sc\\.',
  'Sept\\.', 'Ph\\.D\\.', 'M\\.D\\.', 'B\\.A\\.', 'M\\.A\\.', 'B\\.S\\.', 'M\\.S\\.',
  'LL\\.B\\.', 'LL\\.M\\.', 'J\\.D\\.', 'D\\.D\\.S\\.', 'R\\.N\\.',
  'C\\.E\\.O\\.', 'C\\.F\\.O\\.', 'C\\.O\\.O\\.', 'C\\.T\\.O\\.', 'C\\.I\\.O\\.', 'C\\.M\\.O\\.',
  'a\\.m\\.', 'p\\.m\\.', 'A\\.M\\.', 'P\\.M\\.',
  'Jan\\.', 'Feb\\.', 'Mar\\.', 'Apr\\.', 'Jun\\.', 'Jul\\.', 'Aug\\.', 'Sep\\.', 'Oct\\.', 'Nov\\.', 'Dec\\.',
  'Mon\\.', 'Tue\\.', 'Wed\\.', 'Thu\\.', 'Fri\\.', 'Sat\\.', 'Sun\\.',
  'Rev\\.', 'Hon\\.', 'Capt\\.', 'Lt\\.', 'Col\\.', 'Gen\\.', 'Gov\\.', 'Pres\\.', 'Sgt\\.',
  'Mgr\\.', 'Dept\\.', 'Div\\.', 'Est\\.', 'Ave\\.', 'Blvd\\.', 'Ste\\.', 'Apt\\.',
  'Ltd\\.', 'Inc\\.', 'Corp\\.', 'PLC\\.', 'LLC\\.', 'Intl\\.', 'Misc\\.',
  'Vol\\.', 'Fig\\.', 'Eq\\.', 'Ref\\.', 'Seq\\.', 'Max\\.', 'Min\\.', 'Temp\\.',
  'Alt\\.', 'Lat\\.', 'Long\\.', 'Avg\\.', 'Std\\.', 'Nos\\.',
  // çŸ­ç¼©å†™ï¼ˆååŒ¹é…ï¼Œé¿å…æˆªæ–­é•¿ç¼©å†™ï¼‰
  'Mr\\.', 'Mrs\\.', 'Ms\\.', 'Dr\\.', 'Prof\\.', 'Sr\\.', 'Jr\\.', 'St\\.',
  'e\\.g\\.', 'i\\.e\\.', 'etc\\.', 'vs\\.', 'v\\.', 'No\\.', 'Mt\\.', 'Rd\\.',
  'Ln\\.', 'Ch\\.', 'Sec\\.', 'Co\\.', 'Box\\.', 'Sq\\.'
];
const abbrPlaceholder = 'â—†'; // ä¸´æ—¶å ä½ç¬¦ï¼Œä¸ä¼šå‡ºç°åœ¨æ­£å¸¸è‹±æ–‡æ–‡æœ¬ä¸­

// ========== ã€æ ¸å¿ƒä¿®æ”¹2ï¼šä¼˜åŒ–å¥å­æ‹†åˆ†é€»è¾‘ï¼Œç¼©å†™ä¸è¢«é”™è¯¯æ–­å¼€ï¼ŒåŸæœ‰é€»è¾‘å®Œå…¨å…¼å®¹ã€‘==========
goBtn.addEventListener('click', () => {
  const text = inputArea.value.trim();
  if (!text) return;

  // 1. é¢„å¤„ç†ï¼šæŠŠæ‰€æœ‰ç¼©å†™é‡Œçš„.æ›¿æ¢æˆå ä½ç¬¦ï¼Œé¿å…è¢«å½“æˆå¥æœ«ç¬¦å·æ‹†åˆ†ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
  let processedText = text;
  englishAbbrs.forEach(abbr => {
    // å•è¯è¾¹ç•ŒåŒ¹é…ï¼Œé¿å…åŒ¹é…åˆ°å•è¯ä¸­é—´çš„å­—ç¬¦ï¼Œå…¨å±€ä¸åŒºåˆ†å¤§å°å†™
    const abbrRegex = new RegExp(`(\\b)${abbr}`, 'gi');
    // æŠŠç¼©å†™é‡Œçš„.æ›¿æ¢æˆå ä½ç¬¦ï¼Œä¿ç•™åŸæœ‰çš„å•è¯è¾¹ç•Œå’Œå¤§å°å†™
    const replacedAbbr = abbr.replace(/\\\./g, abbrPlaceholder);
    processedText = processedText.replace(abbrRegex, `$1${replacedAbbr}`);
  });

  // 2. æ²¿ç”¨ä½ åŸæœ‰çš„æ‹†åˆ†é€»è¾‘ï¼Œå®Œå…¨å…¼å®¹åŸæœ‰è§„åˆ™ï¼Œä»…è¿‡æ»¤äº†ç¼©å†™é‡Œçš„ç‚¹
  const splitSymbols = /([.,?!;:ã€ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼š])/g;
  const rawParts = processedText.split(splitSymbols);
  const segments = [];
  
  for (let i = 0; i < rawParts.length; i += 2) {
    let part = (rawParts[i] || '') + (rawParts[i + 1] || '');
    part = part.trim();
    if (part) segments.push(part);
  }

  // 3. è¿˜åŸï¼šæŠŠæ‰€æœ‰å ä½ç¬¦æ¢å›.ï¼Œæ¢å¤åŸæ–‡
  const finalSegments = segments.map(seg => seg.replace(new RegExp(abbrPlaceholder, 'g'), '.'));

  // 4. æ²¿ç”¨ä½ åŸæœ‰çš„æ¸²æŸ“é€»è¾‘ï¼Œå®Œå…¨ä¸æ”¹åŠ¨åŸæœ‰åŠŸèƒ½
  renderResult(finalSegments);
});

function renderResult(segments) {
  result.innerHTML = '';
  segments.forEach(seg => {
    const sentenceDiv = document.createElement('div');
    sentenceDiv.className = 'sentence';

    const speaker = document.createElement('div');
    speaker.className = 'speaker';
    speaker.textContent = 'ğŸ”Š';

    const wordsDiv = document.createElement('div');
    wordsDiv.style.width = '100%';

    const words = seg.split(/\s+/).filter(Boolean);
    words.forEach(word => {
      const w = document.createElement('span');
      w.className = 'word';
      w.textContent = word;
      w.onclick = (e) => {
        e.stopPropagation();
        speakWord(word, w);
      };
      wordsDiv.appendChild(w);
      wordsDiv.appendChild(document.createTextNode(' '));
    });

    sentenceDiv.appendChild(speaker);
    sentenceDiv.appendChild(wordsDiv);
    sentenceDiv.onclick = () => speakSentence(seg, sentenceDiv);
    result.appendChild(sentenceDiv);
  });
}

// æœ—è¯»å¥å­
function speakSentence(text, sentenceEl) {
  stopSpeaking();
  document.querySelectorAll('.sentence').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.word').forEach(w => w.classList.remove('active'));

  const u = new SpeechSynthesisUtterance(text);
  u.voice = getSelectedVoice();
  u.rate = 0.96;
  u.pitch = 1.0;

  sentenceEl.classList.add('active');
  u.onend = () => sentenceEl.classList.remove('active');
  window.speechSynthesis.speak(u);
  currentUtterance = u;
}

// æœ—è¯»å•è¯
function speakWord(word, wordEl) {
  stopSpeaking();
  document.querySelectorAll('.sentence').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.word').forEach(w => w.classList.remove('active'));
  wordEl.classList.add('active');

  const u = new SpeechSynthesisUtterance(word);
  u.voice = getSelectedVoice();
  u.rate = 0.9;
  window.speechSynthesis.speak(u);
}

function stopSpeaking() {
  if (window.speechSynthesis.speaking) {
    window.speechSynthesis.cancel();
  }
}
</script>
</body>
</html>
